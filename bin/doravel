#!/bin/bash

function print_help {
    echo 'Modo de uso: doravel [COMMAND] [OPTIONS]

COMMAND:
    init      Inicia un proyecto con doravel
    start     Restablece todos los servicios
    up        Iniciar los servicios del proyecto
    stop      Pausa todos los servicios
    down      Para y eliminar los servicios
    restart   Reiniciar los servicios
    reload    Recarrega los servicios
    console   Abre el terminal bash de doravel
    terminal  Abre el terminal bash de doravel
    artisan   Ejecuta un comando artisan
    fix       Corrige el usuario y grupo

OPTIONS:
    -e | --env     .env file to use
    -h | --help    show this help
    -v | --version show version

'
}

if [ "$1" == "" ]; then
    print_help
    exit 0
fi

if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
    print_help
    exit 0
fi

if [ ! -d "./app" ] || [ ! -f "./.env" ]; then
    echo "the current directory is not a laravel project"
    exit 0
fi

COMMAND="$1"

if [ $COMMAND == "init" ]; then
    echo "Initializing doravel..."
    read -p "Do you want to initialize doravel? [y/N] " RESPOSE

    if [ "$RESPOSE" == "y" ]; then
        bash <(curl https://raw.githubusercontent.com/byancode/doravel/main/bin/init)
    fi

    exit 0
fi

if [ $COMMAND != "" ]; then
    echo "Running doravel with command $COMMAND..."
else
    echo "Running doravel..."
fi

# compobamos si exite el comando

if [ $COMMAND != "init" ] && [ $COMMAND != "start" ] && [ $COMMAND != "up" ] && [ $COMMAND != "stop" ] && [ $COMMAND != "down" ] && [ $COMMAND != "restart" ] && [ $COMMAND != "reload" ] && [ $COMMAND != "console" ] && [ $COMMAND != "terminal" ] && [ $COMMAND != "artisan" ] && [ $COMMAND != "fix" ] && [ $COMMAND != "ps" ] && [ $COMMAND != "top" ] && [ $COMMAND != "build" ] && [ $COMMAND != "help" ] && [ $COMMAND != "logs" ] && [ $COMMAND != "ssh-keys" ] && [ $COMMAND != "upgrade" ] && [ $COMMAND != "global" ]; then
    echo "the command $COMMAND is not valid"
    exit 0
fi

# comandos que no requiere de un .env

if [ $COMMAND == "fix" ]; then
    sudo chown -R $(id -un):$(id -gn) ./storage
    sudo chown -R $(id -un):$(id -gn) ./bootstrap/cache

    exit 0
fi

if [ $COMMAND == "global" ] && [ -f ./doravel ]; then
    echo "Install doravel global..."
    if [ ! -d ~/bin ]; then
        mkdir ~/bin
    fi
    cp ./doravel ~/bin/doravel
    chmod +x ~/bin/doravel

    exit 0
fi

if [ $COMMAND == "upgrade" ]; then
    echo "Upgrading doravel..."
    curl -H 'Cache-Control: no-cache, no-store' "https://raw.githubusercontent.com/byancode/doravel/main/bin/doravel?$RANDOM" -o ./doravel
    if [ ! -d ~/bin ]; then
        mkdir ~/bin
    fi
    cp ./doravel ~/bin/doravel
    chmod +x ~/bin/doravel
    chmod +x ./doravel

    exit 0
fi


if [ $COMMAND == "ssh-keys" ]; then
    echo "Generating ssh keys..."
    if [ ! -d ./storage/.ssh ]; then
        mkdir ./storage/.ssh

        echo '*'             > ./storage/.ssh/.gitignore
        echo '!.id_rsa'     >> ./storage/.ssh/.gitignore
        echo '!.id_rsa.pub' >> ./storage/.ssh/.gitignore
    fi
    if [ ! -f ./storage/.ssh/id_rsa ]; then
        email=$(git config --global user.email)
        ssh-keygen -t rsa -b 4096 -C "$email" -f ./storage/.ssh/id_rsa -q -N ""
        chmod 600 ./storage/.ssh/id_rsa
    fi

    exit 0
fi

# comandos que requieren de un .env

ENV_FILE=".env"
ENV_NAME="local"
DCP_NAME="docker-compose"

if [ ! -f "$DCP_NAME.yml" ]; then
    echo "this project does not have a docker-compose.yml file"
    exit 1
fi

OPTIONS=''
while [ "$#" -gt 0 ]; do
    case "$2" in
        -e | --env)
            ENV_NAME="$3"
            ENV_FILE=".env.$ENV_NAME"
            shift 2
            ;;
        --local)
            ENV_NAME="local"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        --test)
            ENV_NAME="test"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        --testing)
            ENV_NAME="testing"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        --dev)
            ENV_NAME="dev"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        --development)
            ENV_NAME="development"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        --prod)
            ENV_NAME="prod"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        --production)
            ENV_NAME="production"
            ENV_FILE=".env.$ENV_NAME"
            shift
            ;;
        *)
            if [[ "$2" =~ ^- ]]; then
                OPTIONS="$OPTIONS $2"
                shift
                continue
            fi
            OPTIONS="$OPTIONS $2"
            shift
            ;;
    esac
done

if [ "$ENV_NAME" == "" ]; then
    ENV_NAME="local"
fi

if ! [[ "$ENV_NAME" =~ ^[a-zA-Z0-9]+$ ]]; then
    echo "the environment name $ENV_NAME is not valid"
    exit 0
fi

if [ ! -f "./$DCP_NAME.yml" ]; then
    ARGUMENTS="--file=$DCP_NAME.yml"
else
    ARGUMENTS=""
fi

if [ "$ENV_NAME" != "" ]; then
    ENV_FILE=".env.$ENV_NAME"
    DCP_NAME="docker-compose.$ENV_NAME"
fi

if [ "$ENV_NAME" == "testing" ] && [ ! -f "./$ENV_FILE" ] && [ -f "./.env.test" ]; then
    ENV_NAME="test"
    ENV_FILE=".env.$ENV_NAME"
    DCP_NAME="docker-compose.$ENV_NAME"
fi

if [ "$ENV_NAME" == "development" ] && [ ! -f "./$ENV_FILE" ] && [ -f "./.env.dev" ]; then
    ENV_NAME="dev"
    ENV_FILE=".env.$ENV_NAME"
    DCP_NAME="docker-compose.$ENV_NAME"
fi

if [ "$ENV_NAME" == "production" ] && [ ! -f "./$ENV_FILE" ] && [ -f "./.env.prod" ]; then
    ENV_NAME="prod"
    ENV_FILE=".env.$ENV_NAME"
    DCP_NAME="docker-compose.$ENV_NAME"
fi

if [ "$ENV_NAME" == "prod" ] || [ "$ENV_NAME" == "production" ]; then
    if [ ! -f "./$ENV_FILE" ]; then
        ENV_NAME="local"
        ENV_FILE=".env.$ENV_NAME"
        DCP_NAME="docker-compose.$ENV_NAME"
    fi
fi

if [ "$ENV_NAME" != "local" ] && [ ! -f "./$ENV_FILE" ]; then
    echo "the environment file $ENV_FILE does not exist"
    exit 0
fi

if [ "$ENV_NAME" != "local" ] && [ ! -f "./$ENV_FILE" ]; then
    echo "the environment file $ENV_FILE does not exist"
    exit 0
fi

if [ ! -f "./$ENV_FILE" ]; then
    ENV_NAME="local"
    ENV_FILE=".env"
fi

DCP_OVERRIDE="docker-compose.override"

if [ "$ENV_NAME" != "local" ] && [ -f "./$DCP_OVERRIDE.yml" ]; then
    ARGUMENTS="$ARGUMENTS --file=$DCP_OVERRIDE.yml"
fi

if [ -f "./$DCP_NAME.yml" ]; then
    ARGUMENTS="$ARGUMENTS --file=$DCP_NAME.yml"
fi

# get name from this current directory
DIR_NAME=$(basename $(pwd))
PROJECT_NAME=$(echo $DIR_NAME | sed 's/[^a-zA-Z0-9]/-/g')
PROJECT_NAME="${PROJECT_NAME}__${ENV_NAME}"
ARGUMENTS="$ARGUMENTS --project-name=$PROJECT_NAME --env-file=$ENV_FILE"

if [ $COMMAND == "console" ] || [ $COMMAND == "terminal" ]; then
    docker-compose $(echo $ARGUMENTS) exec -- doravel bash
fi

if [ $COMMAND == "artisan" ]; then
    docker-compose $(echo $ARGUMENTS) exec -- doravel php artisan $(echo $OPTIONS)
fi

if [ $COMMAND == "up" ]; then
    docker-compose $(echo $ARGUMENTS) up $(echo $OPTIONS)
fi

if [ $COMMAND == "start" ]; then
    docker-compose $(echo $ARGUMENTS) start
fi

if [ $COMMAND == "restart" ] || [ $COMMAND == "reload" ]; then
    docker-compose $(echo $ARGUMENTS) restart -- doravel
fi

if [ $COMMAND == "down" ]; then
    docker-compose $(echo $ARGUMENTS) down $(echo $OPTIONS)
fi

if [ $COMMAND == "stop" ]; then
    docker-compose $(echo $ARGUMENTS) stop
fi

if [ $COMMAND == "ps" ] || [ $COMMAND == "top" ] || [ $COMMAND == "build" ] || [ $COMMAND == "help" ] || [ $COMMAND == "logs" ]; then
    docker-compose $(echo $ARGUMENTS) $(echo $COMMAND) $(echo $OPTIONS)
fi
