#!/bin/bash

set -eu

echo $$ > /var/run/artisand.pid

cleanup() {
    rm -f /var/run/artisand.pid
    exit 0
}

trap cleanup SIGTERM
trap cleanup SIGQUIT
trap cleanup EXIT


if [ ! -f /usr/local/bin/php-cli ]; then
    gum log --time rfc822 --level fatal "No has instalado PHP"
    # TODO - aqui debe hacer informacion de como usar el comando builder para instalar PHP
    exit 1
fi

APP_PATH=${APP_PATH:-"/var/www"}
source $(get_env_file $APP_ENV)

OCTANE_ENABLED=${OCTANE_ENABLED:-'true'}
TIMEZONE_FILE='/usr/share/zoneinfo/'$APP_TIMEZONE

if [ -z "$APP_TIMEZONE" ] || [ ! -f "$TIMEZONE_FILE" ]; then
    APP_TIMEZONE='UTC'
fi

if [ ! -f "$TIMEZONE_FILE" ]; then
    ln -snf /usr/share/zoneinfo/UTC /etc/localtime
else
    ln -snf "$TIMEZONE_FILE" /etc/localtime
fi

if [ ! -d $APP_PATH/vendor ]; then
    gum log --time rfc822 --level fatal "No has instalado las dependencias de Composer"
    exit 1
fi

if [ -z "$APP_KEY" ]; then
    gum log --time rfc822 --level fatal "No has configurado la APP_KEY"
    exit 1
fi

if [ ! -L $APP_PATH/public/storage ]; then
    gum log --time rfc822 --level fatal "No has linkeado la carpeta public/storage"
    exit 1
fi

if [ -d $APP_PATH/vendor/laravel/octane ] && is_true $OCTANE_ENABLED; then
    /usr/local/bin/octaned $@
else
    /usr/local/bin/artisan serve $@
fi
