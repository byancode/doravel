#!/bin/bash

echo $$ > /var/run/nginxd.pid

cleanup() {
    if [ ! -z "$child" ]; then
        kill -SIGTERM $child 2>/dev/null
    fi

    rm -f /var/run/nginxd.pid
    exit 0
}

trap cleanup SIGQUIT
trap cleanup SIGTERM
trap cleanup EXIT

if [ ! -f /usr/sbin/nginx ]; then
    gum log --time rfc822 --level fatal "No has instalado nginx"
    # TODO - aqui debe hacer informacion de como usar el comando builder para instalar nginx
    exit 1
fi

CONFIGURATION_FILE="/var/www/.doravel/nginx/$APP_ENV.conf"

if [ ! -f $CONFIGURATION_FILE ]; then
    echo "No se encontró el archivo de configuración $CONFIGURATION_FILE"
    exit 1
fi

# TODO - habilitar reverb a nginx conf si existe la carpeta vendor/laravel/reverb

echo "Iniciando nginx..."
/usr/sbin/nginx -c "$CONFIGURATION_FILE" -g "daemon off;" $@ &
child=$!
wait "$child"
