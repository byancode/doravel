#!/bin/ash

echo $$ > /var/run/doraveld.pid

echo "Iniciando doraveld..."

cleanup() {
    rm -f /var/run/doraveld.pid
    exit 0
}

trap cleanup INT TERM
trap cleanup EXIT

if [ ! -f /usr/bin/supervisord ]; then
    gum log --time rfc822 --level fatal "No has instalado supervisord"
    # TODO - aqui debe hacer informacion de como usar el comando builder para instalar supervisor
    exit 1
fi

if [ ! -f /usr/local/bin/php-cli ]; then
    gum log --time rfc822 --level fatal "No has instalado PHP"
    # TODO - aqui debe hacer informacion de como usar el comando builder para instalar PHP
    exit 1
fi

if [ ! -f /usr/local/bin/composer ]; then
    gum log --time rfc822 --level fatal "No has instalado Composer"
    # TODO - aqui debe hacer informacion de como usar el comando builder para instalar Composer
    exit 1
fi

while true; do
    CONFIGURATION_FILE="/var/www/.doravel/supervisor/$APP_ENV.conf"

    if [ ! -f $CONFIGURATION_FILE ]; then
        echo "No se encontró el archivo de configuración $CONFIGURATION_FILE, esperando 2 segundos..."
        sleep 2
        continue
    fi

    /usr/bin/supervisord --nodaemon --configuration $CONFIGURATION_FILE
    echo "supervisord se ha detenido. Reiniciando en 1 segundo..."
    sleep 1
done