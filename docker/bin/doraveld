#!/bin/ash

echo $$ > /var/run/doraveld.pid

echo "Iniciando doraveld..."

cleanup() {
    rm -f /var/run/doraveld.pid
    exit 0
}

trap cleanup INT TERM

while true; do
    CONFIGURATION_FILE="/var/www/.doravel/supervisor/$APP_ENV.conf"

    if [ ! -f $CONFIGURATION_FILE ]; then
        echo "No se encontró el archivo de configuración $CONFIGURATION_FILE, esperando 2 segundos..."
        sleep 2
        continue
    fi

    /usr/bin/supervisord --nodaemon --configuration $CONFIGURATION_FILE
    echo "supervisord se ha detenido. Reiniciando en 1 segundo..."
    sleep 1
done