#!/bin/bash
set -eu

cleanup() {
    if [ ! -z "$child" ]; then
        kill -SIGTERM $child 2>/dev/null
    fi
    exit 0
}

trap cleanup SIGQUIT
trap cleanup SIGTERM
trap cleanup EXIT

APP_PATH=${APP_PATH:-"/var/www"}
CRONTAB_DIR="/var/spool/cron/crontabs"
CRONTAB_FILE="$CRONTAB_DIR/$(whoami)"

CONFIGURATION_FILE="$APP_PATH/.doravel/cron/$APP_ENV"

if [ ! -f "$CONFIGURATION_FILE" ]; then
    gum log --time rfc822 --level fatal "No se encontró el archivo de configuración $CONFIGURATION_FILE"
    exit 1
fi

cp -f "$CONFIGURATION_FILE" "$CRONTAB_FILE"

/usr/sbin/crond -f -l 0 -c "$CRONTAB_DIR" &
child=$!
wait "$child"