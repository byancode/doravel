#!/bin/bash

url=$(git config --get remote.origin.url)
name=$(git config --get user.name)
email=$(git config --get user.email)
branch=$(git rev-parse --abbrev-ref HEAD)
repository=$(git config --get remote.origin.url | sed 's/.*\:\(.*\)\.git/\1/')

if [ ! -d $PWD/ssh ]; then
    mkdir $PWD/ssh
fi
if [ -f $PWD/ssh/id_rsa.pub ]; then
    rm $PWD/ssh/id_rsa.pub
fi
if [ -f $PWD/ssh/id_rsa ]; then
    rm $PWD/ssh/id_rsa
fi

ssh-keygen -t rsa -b 4096 -C "$email" -f $PWD/ssh/id_rsa -q -N ""

echo ""
echo "### SSH key generated ###"
echo ""
cat $PWD/ssh/id_rsa.pub
echo ""
echo ""
echo "⚠️⚠️ IMPORTANTE ⚠️⚠️"
echo "No olvide agregar la clave pública a su repositorio de GitHub!"
echo "👇️ Deploy keys 👇️"
echo "https://docs.github.com/es/developers/overview/managing-deploy-keys#deploy-keys"
echo ""

RSA_KEY=$(cat $PWD/ssh/id_rsa | base64 --wrap=0)
RSA_PUB=$(cat $PWD/ssh/id_rsa.pub | base64 --wrap=0)

script='#!/bin/bash

sudo dnf -y install dnf-plugins-core git
sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
sudo dnf -y install docker-ce docker-ce-cli containerd.io

sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose &&  chmod +x /usr/local/bin/docker-compose
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

git config --global user.name "'$name'"
git config --global user.email "'$email'"

echo "'$RSA_KEY'" | base64 -d > $HOME/.ssh/id_rsa
echo "'$RSA_PUB'" | base64 -d > $HOME/.ssh/id_rsa.pub

sudo systemctl start docker
git clone --branch='$branch' '$url' /www
'
script=$(echo "$script" | base64 --wrap=0)
echo 'echo "'$script'" | bash' > $PWD/server.sh